#!/bin/bash
## cccheck
##
## Check for connections of a specific container across EC2 (ECS/docker) instances
## Will not fail if no containers are found
##
#

if [ $# -eq 1 -o $# -eq 2 ]; then
	echo -n
else
	echo "Usage: cccheck container-name1[,container-name-2,container-name3...container-name-N] [TIME_WAIT]" 1>&2
	exit 1
fi

CONTAINERS="$1" ## container names
ST="$2"

TMPF=$(mktemp)

## access ip_conntrack via sudo only once
if [ ! -z "$ST" ]; then
	sudo grep -F "$ST" /proc/net/ip_conntrack >> "$TMPF" || exit $?
else
	sudo cat /proc/net/ip_conntrack >> "$TMPF" || exit $?
fi

## split by comma
IFS=',' read -a CONTAINERS <<< "$CONTAINERS"

for CNAME in ${CONTAINERS[@]}; do
	CID=$(docker ps | awk '{ print $NF}' | grep -F "$CNAME")
	if [ -z "$CID" ]; then
		## no match is not an error
		continue
	fi
	CIP=$(docker inspect --format='{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' $CID) || exit $?
	echo -n -e "$HOSTNAME\t$CID\t$CNAME: "
	grep -F "src=$CIP" "$TMPF" | wc -l
done

rm "$TMPF"
